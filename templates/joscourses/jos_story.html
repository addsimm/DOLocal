{% extends "base.html" %}
{% load i18n mezzanine_tags accounts_tags  static %}
{% block meta_title %}{{ story.title | striptags | safe | truncatechars:25 }}{% endblock %}
{% block title %}{{ story.title | striptags  | safe | truncatechars:25 }}{% endblock %}
{% block breadcrumb_menu %}
    {{ block.super }}{{ story.title  | striptags | safe | truncatechars:120 }}{% endblock %}

{% block footer %}{% endblock %}

{% block all_content %}

    <style>

        input {
            display: none;
        }

        /* The autosave_checkbox, around the autosave_slider */
        .autosave_checkbox {
            position: relative;
            top: 3px;
            margin-left: 10px;
            height: 40px;
            width: 100px;
            outline: 2px solid #412d78;
        }

        /* autosave_slider */
        .autosave_slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
        }

        .autosave_slider:before {
            position: absolute;
            color: white;
            font-size: 14pt;
            text-align: center;
            content: "OFF";
            top: 0;
            left: 0;
            height: 40px;
            width: 50px;
            padding-top: 7px;
            background-color: #5bc0de;
        }

        .autosave_slider:hover::before {
            border: 3px dotted #f0ad4e;
            color:  #f0ad4e;
            background-color: white;
        }

        input:checked + .autosave_slider {
            background-color: #5cb85c;
        }

        input:checked + .autosave_slider:before {
            transform: translateX(50px);
            content: "ON";
        }

        /* permissions radio */
        .perm_label {
            background-color: white;
            font-size: 14pt;
            text-align: center;
            height: 40px;
            width: 100px;
            padding-top: 7px;
            color: #5bc0de;
            cursor: pointer;
        }

        .perm_label:hover {
            border: 3px dotted #f0ad4e;
            color: #f0ad4e;
            background-color: white;
        }

        .perm_uncheck {
            color: #5bc0de;
            background-color: white;
        }

        .perm_checked {
            color: white !important;
            background-color: #5bc0de !important;
        }

        #left_story_tools button {
            margin-left: 10px;
        }

    </style>

    <div id="left_story_tools" style="background-color: aliceblue; visibility: hidden;
        position: absolute; top: 0; left: 5px; height: 55px; width: 547px;
        display: flex; justify-content: flex-start; align-items: flex-end;">

        <button class="j_button_small j_info_button"
                onclick=" ">
            <i class="fa fa-circle fa-fw"></i>
            WHEEL
        </button>

        <button class="j_button_small j_relocate_button"
                onclick=" ">
            <i class="fa fa-square fa-fw"></i>
            VERSIONS
        </button>

        <button class="j_button_small j_action_button"
                onclick=" ">
            <i class="fa fa-scissors fa-fw"></i>
            RE-TITLE
        </button>

        <button class="j_button_small j_action_button"
                onclick=" ">
            <i class="fa fa-exclamation fa-fw"></i>
            READ / SEND
        </button>
    </div>

    <div id="right_story_tools" style="background-color: aliceblue; visibility: visible;
         position: absolute; top: 0; left: 550px; height: 55px; width: 600px;
         display: flex; justify-content: flex-start; align-items: center;
         padding-top: 5px;">

        <!-- Autosavce -->
        <div style="font-size: 12pt; font-weight: bold; text-align: right; margin-left: 15px;">
            Auto<br>save:
        </div>
        <label class="autosave_checkbox">
            <input id="autosave_checkbox" type="checkbox" onchange="toggleAutosave(this);">
            <div class="autosave_slider"></div>
        </label>

        <!-- Permission -->
        <div style="font-size: 12pt; font-weight: bold;
             margin-left: 25px; text-align: right">
            Shared<br>with:
        </div>

        <div id="sharing_box" style="
             position: relative; top:0; margin-left: 10px;
             height: 40px; width: 310px;
             outline: 2px solid #412d78;">

            <label id="perm_1" class="perm_label">
                <input type="radio" name="toggle">ONLY ME
            </label>

            <label id="perm_2" class="perm_label">
                <input type="radio" name="toggle">CIRCLES
            </label>

            <label id="perm_3" class="perm_label">
                <input type="radio" name="toggle">PUBLISH
            </label>

        </div>

    </div>

    {% if story.author == request.user %}
        <button id='story_tools_tab' class="j_button j_info_button" style="
                position: absolute; top: 18px; left: 1155px; width: 125px;
                font-size: 14pt; border-radius: 0;"
            onclick="toolsTabHandler(this.id);"
            data-toggle="tooltip" data-placement="bottom"
            title="Shows toolbar">
        <i class="fa fa-cogs fa-fw" style="margin-right: 5px;"></i>
        TOOLS
    </button>
    {% endif %}

    <!-- Editor buttons -->
    <div style="margin: 60px 0 0 30px; display: flex; justify-content: flex-start; align-items: center;">

        <button id="story_content_edit_btn" class="j_button_small j_save_button"
                style=" " onclick="josCKSave('story_content');"
                data-toggle="tooltip" data-placement="bottom"
                title="Updates story content">
            <i class="fa fa-arrow-circle-up fa-fw"></i>
            SAVE STORY NOW
        </button>

        <button id="story_content_discard_btn" class="j_button_small j_discard_button"
                style="margin-left: 5px;"
                onclick="window.location.href = 'https://joinourstory.com/joscourses/josstory/' + {{ story.id }};"
                data-toggle="tooltip" data-placement="bottom"
                title="Reloads recent save and discards changes">
            <i class="fa fa-trash fa-fw"></i>
            RESTART EDIT SESSION
        </button>

        <div style="margin-left: auto;">
            {% include "josprojects/../jos_includes/updated_include.html" with myobj=story %}
        </div>

        <!-- Go To Discuss -->
        <button class="j_button_small j_relocate_button" style="margin-left: 15px;"
                onclick="window.location.href='#discuss';">
            <i class="fa fa-comments fa-fw"></i>
            DISCUSS
        </button>
    </div>

    <!-- Story content, holds editor -->
    <div id="story_content_editor_container" style="margin: 5px 0 0 30px; background-color: pink; min-height: 500px;"></div>


    <!-- Discussion -->
    <div class="row">

        <div class="homehead" style="font-size: 28pt; margin: 50px 0 0 45px;">
            Community discussion:
        </div>

        <div class="col-xs-11 col-xs-offset-1" style="margin-top: 0;">

            {% for comment in comments %}

                <div class="row" style="color: rgb(217,83,79); font-size: 20pt; margin-top: 20px;">
                    <div class="col-xs-3">
                        {{ comment.sent_at | date:"M d" }}; {{ comment.sent_at | time:"f A" }}
                    </div>
                </div>

                <div class="row" style="font-size: 20pt; margin-top: 20px;">

                    {% if comment.sender != request.user %}

                        <div class="col-xs-2" style="padding: 0;">
                            {% include "josmembers/user_picture_include.html" with user=comment.sender height=60 %}
                        </div>

                        <div class="col-xs-9"
                             style="border: 1px solid rgb(65, 45, 120); padding: 15px; min-height: 103px;">
                            "{{ comment.body | striptags | safe }}"
                        </div>

                    {% else %}

                        <div class="col-xs-9"
                             style="border: 1px solid rgb(65, 45, 120); padding: 15px;  min-height: 103px;">
                            "{{ comment.body | striptags | safe }}"
                        </div>

                        <div class="col-xs-2">
                            {% include "josmembers/user_picture_include.html" with user=comment.sender height=60 %}
                        </div>

                    {% endif %}

                </div>

            {% endfor %}
        </div>

    </div>

    <div id="discuss" class="row" style="margin: 50px 0 100px 0;">
        <div class="col-xs-10 col-xs-offset-1">

            <!-- Editor buttons -->
            <div style="margin: 0; display: flex; justify-content: flex-start; align-items: center;">

                <button id="comment_edit_btn" class="j_button j_action_button"
                        style=" " onclick="josCKEdit('comment');"
                        data-toggle="tooltip" data-placement="bottom"
                        title="Activates editor">
                    <i class="fa fa-comments fa-fw"></i>
                    ADD YOUR THOUGHT ...
                </button>

                <button id="comment_cancel_btn" class="j_button j_discard_button"
                        style="margin-left: 5px; display: none;"
                        onclick="window.location.href = 'https://joinourstory.com/joscourses/josstory/' + {{ story.id }};"
                        data-toggle="tooltip" data-placement="bottom"
                        title="Discards comment">
                    <i class="fa fa-trash fa-fw"></i>
                    DISCARD
                </button>

            </div>

            <!-- This div holds editor -->
            <div id="comment_editor_container" style=" "></div>

        </div>
    </div>




    <script>

    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();
        if (Number(window.location.href.split('/')[5]) === 0) {
            reload_url = 'https://joinourstory.com/joscourses/josstory/' + {{ story.id }};
            window.location.href = reload_url;
        }

        initJOSEditor('story_content', 'large', '/joscourses/story_update/?id=' + '{{ story.id }}', "{{ story.story_content | escapejs }}");
        initJOSEditor('comment', 'small', '/joscourses/story_update/?id=' + '{{ story.id }}', " ");

        var permission_element_id = 'perm_' + {{ story.publish_permission }};
        var permission_element = document.getElementById(permission_element_id);
        $(permission_element).addClass('perm_checked');

        josCKEdit('story_content');

    });

    var labels = $('#sharing_box').children();
    $(labels).click(function () {
        window.location.href =
            "{% url "joscourses:josstory" story.id %}/?pubperm=" + this.id.split("_")[1];
        $(this).addClass('perm_checked').removeClass('perm_uncheck');
        $(this).siblings().removeClass('perm_checked').addClass('perm_uncheck');
    });

    function toggleAutosave(t) {
        alert('toggleAutosave: ' + t.id);
    }

    function toolsTabHandler(i) {
        var story_tools_tab = document.getElementById(i);
        console.log('story_tools_tab clicked: ' + $(story_tools_tab).attr('class').split(" "));

        if ($(story_tools_tab).hasClass('j_info_button')) {
            $(story_tools_tab)
                    .html("<i class='fa fa-cogs fa-fw' style='margin-right: 5px;'></i>CLOSE")
                    .addClass("isopen j_back_button")
                    .removeClass("isclosed j_info_button")
                    .attr("data-original-title", "Hides toolbar");
            $("#right_story_tools").css({opacity: 0, visibility: "visible"}).animate({opacity: 1}, 1000);
            $("#left_story_tools").css({opacity: 0, visibility: "visible"}).animate({opacity: 1}, 1000);
        } else {
            $(story_tools_tab)
                    .html("<i class='fa fa-cogs fa-fw' style='margin-right: 5px;'></i>TOOLS")
                    .addClass("isclosed j_info_button")
                    .removeClass("isopen j_back_button")
                    .attr("data-original-title", "Shows toolbar");
            $("#right_story_tools").css({visibility: "hidden"});
            $("#left_story_tools").css({visibility: "hidden"});
        }
    }

</script>

{% endblock all_content %}


