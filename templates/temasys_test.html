{% extends "josstaff/staff_base.html" %}
{% load i18n tz pages_tags mezzanine_tags staticfiles %}

{% block outer_breadcrumb %}{% endblock outer_breadcrumb %}

{% block all_content %}

<style>

    #videoSection {
        margin-top: -65px;
        padding: 10px 0;
        border-top: 3px solid rgb(231, 209, 222);
        border-bottom: 3px solid rgb(231, 209, 222);
    }

    .particbox {
        margin-top: 20px;
    }

    .videoContainer {
        background-color: transparent;
        height: 180px;
        margin: 0;
        outline: 7px solid rgb(65, 45, 120);
        padding: 0;
        width: 240px;
    }

    .nameContainer {
        color: green;
        font-family: "Open Sans", sans-serif;
        font-size: 18pt;
        margin-left: 0;
        margin-top: 5px;
        padding: 0;
    }

    #composeContainer {

    }

    .action {
        color: #28a4c9;
        font-style: italic;
        margin-left: 80px;
    }

    .cntnt {
    }

    .usr {
        color: green;
    }
    
    .me {
        color: red;
    }

    .table {
        background-color: white;
        font-family: "Open Sans", sans-serif;
        margin: 0 15px;
        width: 97%;
    }

    .table > tbody > tr > td {
        border: none;
        border-top: 1px dashed rgb(65,45,120);
        line-height: normal;
        padding: 5px 0;
    }

    #composeSection { }

    td {
        border: none;
        padding: 0;
    }

    tr:hover {
        background-color: inherit;
    }

</style>

{# HTML #}

<div id="videoSection" class="row">
    <div id="audienceContainer" class="col-xs-12" style="padding: 0 15px;"></div>
</div>

<div id="messagesSection" class="row" style="background-color: rgb(231, 209, 222); padding-bottom: 25px;">
    <div id="messagesContainer"
         class="col-xs-12"
         style="margin-top: 20px;
                height: 180px;
                overflow-x: hidden;
                overflow-y: auto;">

    </div>
</div>

<div id="composeSection" class="row" style="margin: 20px 0 0 30px;">
    <table style="margin: 10px 0 0 30px;">
        <tr>
            <td style="width: 65%;">
                <input id="composeInput" type="text"
                       style="font-size: 14pt;
                              width: 100%;
                              padding: 10px;
                              border: 3px solid rgb(65,45,120);"
                       placeholder="Add a thought!">
            </td>
            <td>
                <button class="btn btn-default" style="margin-left: 10px;" onclick="sendMessage()">Send</button>
            </td>
        </tr>
    </table>
</div>


{# Scripts #}
<script src="https://cdn.temasys.com.sg/skylink/skylinkjs/0.6.x/skylink.complete.min.js"></script>
<script charset="utf-8">

    LayoutVideoContainers();

    var peerJOSName = 'missing',
        globIsSelf = false,
        JOSSkylink = new Skylink();

// ----
// Chat
// ----

    function sendMessage() {

        var input = document.getElementById('composeInput');
        JOSSkylink.sendP2PMessage(input.value);

        console.log("sendMessage: " + input.value);
        input.value = '';
    }


    function addMessage(usr, cntnt, clssnm) {
        console.log("addMessage: " + cntnt);

        var messagesContainer = document.getElementById('messagesContainer');
        var div = document.createElement('table');
        $(div).addClass('table ' + clssnm);

        var cntntClass = 'cntnt';
        if (usr == 'Me') {
            cntntClass = 'cntnt me';
        }

        var chatMessage = [
            "<tr class='chat-message'>",
            "    <td class='usr' style='overflow-x: hidden; width: 12%; padding-left: 10px;'>" + usr + "</td>",
            "    <td class='" + cntntClass + "' style='overflow-x: hidden;'>" + cntnt + "</td>",
            "</tr>"
        ].join('\n');

        div.innerHTML =  chatMessage;
        messagesContainer.appendChild(div);
    }


    JOSSkylink.on('incomingMessage', function (message, peerId, peerInfo, isSelf) {
        console.log("incomingMessage");
        var user = 'Me', className = 'message';
        if (!isSelf) {
            user = peerJOSName || peerId;
        }
        addMessage(usr = user, cntnt = message.content, clssnm = className);
    });


// ----
// Main
// ----

    // Peer Joined
    JOSSkylink.on('peerJoined', function (peerId, peerInfo, isSelf) {
        console.log('peerJoined Id: ' + peerId);
        globIsSelf = isSelf;

        peerJOSName = 'Me';
        if (!isSelf) {
            peerJOSName = JOSSkylink.getUserData(peerId)['name'];
            addMessage(usr = peerJOSName, cntnt = ' has joined chat', clssnm = 'action');
        }
    });

    // Incoming Stream
    JOSSkylink.on("incomingStream", function (peerId, stream) {
        var vidbox = getNextEmptyVidBox(pId= peerId, uJOSN = peerJOSName);
        vidbox.autoplay = 'autoplay';
        if (globIsSelf) {
            $(vidbox).css('transform','rotateY(-180deg)', 'z-index', '10');
        }
        attachMediaStream(vidbox, stream);
    });

    // Peer left
    JOSSkylink.on('peerLeft', function (peerId, peerInfo, isSelf) {
        console.log('peerLeft Id: ' + peerId);
            if (!isSelf) {
                reclaimSlot(pId);
            }

        if (!isSelf) {
            addMessage(usr = peerJOSName, cntnt = ' has left chat', clssnm = 'action');
        }
    });

    // ENCRYPT ROOM NAME
    JOSSkylink.init('{{ JOSKey }}', function (error, success) {
        // do a check for error or success
        if (error) {
            console.error('Init failed: ', error);
        } else {
            JOSSkylink.joinRoom('my_room', {
                audioFallback: true,
                audio: true, //////////////////////////////////////////////////
                video: true, //////////////////////////////////////////////////
                frameRate: 15
            });
            JOSSkylink.setUserData({
                name: '{{ request.user.JOSProfile.jos_name }}'
            });
        }
    });


// ------
// Layout
// ------

    function getNextEmptyVidBox(pId, uJOSN) {
        for (c = 1; c < 13; c++) {
            var testId = '#vid_' + c + '_empty';
            if ($(testId).length) {
                var nextEmptyID = testId.substr(1);
                break;
            }
        }

        var emptyVidBox = document.getElementById(nextEmptyID);
        emptyVidBox.id = nextEmptyID.slice(0, -5) + pId;

        var nameBoxID = 'name_' + emptyVidBox.id.split('_')[1].toString();
        var nameBox = document.getElementById(nameBoxID);
        nameBox.innerHTML = uJOSN;

        var particBox = document.getElementById('box_' + emptyVidBox.id.split('_')[1].toString());
        $(particBox).removeClass('hidden');

        return emptyVidBox
    }

    function LayoutVideoContainers() {

        for (i = 0; i < 2; i++) {
            var rowI = document.createElement('div');
            $(rowI).addClass('row');
            rowI.id = 'row_' + i;
            document.getElementById('audienceContainer').appendChild(rowI);

            for (j = 1; j < 5; j++) {
                var pstn = (i * 4) + j;
                var newParticBox = document.createElement('div');
                $(newParticBox).addClass('col-xs-3 text-center particbox hidden');
                newParticBox.id = 'box_' + pstn;

                var videoBoxId = 'vid_' + pstn + '_empty';
                var nameBoxId = 'name_' + pstn;

                var particBoxLayout = [
                    "<div class='row'>",
                    "    <video id=" + videoBoxId + " class='videoContainer' autoplay='autoplay'>",
                    "    </video>",
                    "</div>",
                    '<div class="row">',
                    "   <div id=" + nameBoxId + " class='text-center nameContainer'></div>",
                    '</div>'
                ].join('\n');

                $(newParticBox).html(particBoxLayout);

                rowI.appendChild(newParticBox);
            }
        }
    }

    function reclaimSlot(pId) {
        var reclaimedID = ' ';
        for (c = 1; c < 13; c++) {
            var testId = '#vid_' + c + '_' + pId;
            console.log('testId: ' + testId);
            if ($(testId).length) {
                console.log('testId.length: ' + $(testId).length);
                reclaimedID = testId.substr(1);
                break;
            }
        }

        var pstn = reclaimedID.split('_')[1].toString();

        reParticBox = document.getElementById('box_' + pstn);
        $(reParticBox).addClass('hidden');
        var videoBoxId = 'vid_' + pstn + '_empty';
        var nameBoxId = 'name_' + pstn;

        var particBoxLayout = [
            "<div class='row'>",
            "    <video id=" + videoBoxId + " class='videoContainer' autoplay='autoplay'>",
            "    </video>",
            "</div>",
            '<div class="row">',
            "   <div id=" + nameBoxId + " class='text-center nameContainer'></div>",
            '</div>'
        ].join('\n');

        $(reParticBox).html(particBoxLayout);
    }


// Unused

    // JOSSkylink.on("readyStateChange", function (state, room) {
    //     console.log("Room (" + room + ") state: ", room);
    // });

</script>

{% endblock all_content %}


