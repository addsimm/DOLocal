{% extends "josstaff/staff_base.html" %}
{% load i18n tz pages_tags mezzanine_tags staticfiles %}

{% block outer_breadcrumb %}{% endblock outer_breadcrumb %}

{% block all_content %}

    <style>

        .container {
            margin-top: 0;
        }

        .videoContainer {

        }

        .nameContainer {
            color: green;
            font-family: "Open Sans", sans-serif;
            font-size: 18pt;
            margin: 0;
            padding: 10px;
            width: 240px;
        }

        video {
            height: 160px;
            margin: 0;
            padding: 0;
            width: 240px;
        }

    </style>

    {# <span class="josinstructions">Facilitator:</span> #}

    <div class="row josinstructions" style="margin-top: -50px;">

        <div id="audienceContainer" class="col-xs-12" style="padding: 15px 25px; background-color: transparent; ">

            <video id="myvideo" style="transform: rotateY(-180deg);" autoplay muted></video>

        </div>

    </div>

    {# scripts #}
    <script src="https://cdn.temasys.com.sg/skylink/skylinkjs/0.6.x/skylink.complete.min.js"></script>

    <script charset="utf-8">

        LayoutVideoContainer();

        var SkylinkDemo = new Skylink();


        // Peer Joined
        SkylinkDemo.on('peerJoined', function (peerId, peerInfo, isSelf) {
            console.log('peerJoined Id: ' + peerId);
            console.log('peerJoined Info: ' + peerInfo);
            if (isSelf) return; // self - video element already created above

            // create element for peer video:
            var vid = document.createElement('video');
            vid.autoplay = true;
            vid.muted = true; // Added to avoid feedback when testing locally
            vid.id = peerId;
            document.getElementById('audienceContainer').appendChild(vid);
        });


        // Incoming Stream
        SkylinkDemo.on('incomingStream', function (peerId, stream, isSelf) {
            console.log('incomingStream Id: ' + peerId);
            if (isSelf) return;
            var vid = document.getElementById('vid_1_empty');
            // attach media stream
            attachMediaStream(vid, stream);
            console.log('incomingStream attached');
        });








        SkylinkDemo.on('peerLeft', function (peerId, peerInfo, isSelf) {
            console.log('peerLeft Id: ' + peerId);
            var vid = document.getElementById(peerId);
            document.getElementById('audienceContainer').removeChild(vid);
        });

        SkylinkDemo.on('mediaAccessSuccess', function (stream) { // 'local media stream'
            console.log('3. mediaAccessSuccess: ' + stream);
            var vid = document.getElementById('vid_1_empty');
            var vid1 = document.getElementById('myvideo');
            attachMediaStream(vid, stream);
            attachMediaStream(vid1, stream);
            console.log('mediaAccessSuccess attached');
        });

        SkylinkDemo.on("readyStateChange", function (state, room) {
            console.log("Room (" + room + ") state: ", room);
        });

        // ENCRYPT ROOM NAME - HIDE API KEY
        // always remember to call init()!!!
        SkylinkDemo.init({
            appKey: "441543cd-a1c5-4d93-a25c-3339daa9b959",
            defaultRoom: "defaultroom"
            },
            function (error, success) {
            console.log('1. Skylink init: ' + success);

            // do a check for error or success
            if (error) {
                console.error("Init failed error: ", error);
            } else {
                console.log('2. joinRoom init');
                SkylinkDemo.joinRoom({
                    userData: '{{ request.user.username }}',
                    video: {
                        resolution: SkylinkDemo.VIDEO_RESOLUTION.HQVGA
                    },
                    audio: true,
                    audioFallback: true,
                    frameRate: 15
                });
            }
        });

        // ----------------
        // Layout functions
        // ----------------

        function getNextEmptyVidBox(divIdName, publish) {
            for (c = 1; c < 13; c++) {
                var testID = '#vid_' + c + '_empty';
                if ($(testID).length) {
                    nextEmptyID = testID.substr(1);
                    break;
                }
            }

            var emptyVidBox = document.getElementById(nextEmptyID);
            emptyVidBox.id = nextEmptyID.slice(0, -5) + divIdName.slice(0, -1).split(' ').join('_');
            if (publish == true) {
                emptyVidBox.style.zIndex = 10;
            }

            var nameBoxID = 'name_' + vidBox.id.split('_')[1].toString();
            var nameBox = document.getElementById(nameBoxID);
            nameBox.innerHTML = divIdName;

            var particBox = document.getElementById('box_' + vidBox.id.split('_')[1].toString());
            $(particBox).removeClass('hidden');

            return emptyVidBox
        }

        function LayoutVideoContainer() {

            for (i = 0; i < 4; i++) {
                var rowI = document.createElement('div');
                $(rowI).addClass('row');
                rowI.id = 'row_' + i;
                document.getElementById('audienceContainer').appendChild(rowI);

                for (j = 1; j < 5; j++) {
                    var newParticBox = document.createElement('div');
                    $(newParticBox).addClass('col-xs-3 hidden text-center');
                    newParticBox.id = 'box_' + (i * 4 + j);

                    var newVidBox = document.createElement('video');
                    newVidBox.id = 'vid_' + (i * 4 + j) + '_empty';
                    $(newVidBox).addClass('row videoContainer').innerHTML = newVidBox.id;
                    newParticBox.appendChild(newVidBox);

                    var newNameBox = document.createElement('div');
                    newNameBox.id = 'name_' + (i * 4 + j);
                    $(newNameBox).addClass('row text-center nameContainer').innerHTML = newNameBox.id;
                    newParticBox.appendChild(newNameBox);

                    rowI.appendChild(newParticBox);
                }
            }
        }

        function reclaimSlot(e) {
            var reclaimedID = ' ';
            var subscriber_jos_name = e.stream.name.split(',')[0];
            subscriber = subscriber_jos_name.slice(0, -1).split(' ').join('_');
            for (c = 1; c < 13; c++) {
                var testID = '#vid_' + c + '_' + subscriber;
                if ($(testID).length) {
                    reclaimedID = testID.substr(1);
                    break;
                }
            }

            var position = reclaimedID.split('_')[1].toString();

            particBox = document.getElementById('box_' + position);
            $(particBox).empty().addClass('hidden');

            vidBox = document.createElement('video');
            $(vidBox).addClass('row videoContainer');
            vidBox.id = 'vid_' + position + '_empty';
            vidBox.innerHTML = vidBox.id;
            particBox.appendChild(vidBox);

            var nameBox = document.createElement('div');
            $(nameBox).addClass('row text-center nameContainer');
            nameBox.id = 'name_' + position;
            nameBox.innerHTML = nameBox.id;
            particBox.appendChild(nameBox);
        }

    </script>

{% endblock all_content %}


