{% extends "base.html" %}
{% load i18n mezzanine_tags accounts_tags cloudinary %}

{% cloudinary_includes %}

{% block meta_title %}
    {{ user.JOSProfile.jos_name }}
{% endblock %}
{% block title %}
    {{ user.JOSProfile.jos_name }}
{% endblock %}
{# block body_id }account{ endblock #}

{% block breadcrumb_menu %}
    {{ block.super }}
    Currently at:
    &nbsp&nbsp
    <span style="color: black; font-weight: bold;">
        {{ user.get_short_name }}'s Profile
    </span>
{% endblock %}

{% block all_content %}

    <div class="row" style="margin-top: 50px;">

        <div class="col-xs-2 text-center" style="padding: 3px;">

            <div style="{% if edit %}outline: 3px dashed #28a4c9;{% endif %} padding: 10px;">

                {% if "noimage" in profile.profile_image_idstr %}
                    <img class="img-responsive" src="/static/img/coming-soon-profile.png">
                {% else %}
                    <img class="img-responsive"
                         src="http://res-4.cloudinary.com/desg88u7l/image/upload/{{ profile.profile_image_idstr }}">
                {% endif %}

            </div>

            <style>
                .change-image {
                    margin-top: 0;
                    outline: none;
                    text-decoration: none;
                }
            </style>


            {% if edit %}

                {% cloudinary_includes %}

                <script src="//widget.cloudinary.com/global/all.js" type="text/javascript"></script>

                <script type="text/javascript">
                    var publicid = "{{ potentialNewProfileImageIdStr }}";
                    $(function () {
                        $('#upload_widget_opener').cloudinary_upload_widget(
                                {
                                    cloud_name: 'desg88u7l',
                                    upload_preset: 'b1wbumye',
                                    theme: 'minimal',
                                    sources: ['local','camera'],
                                    multiple: false,
                                    public_id: publicid,
                                    tags: ['profile_image', '{{ profile.user.username }}'],
                                    client_allowed_formats: ["png", "gif", "jpeg"],
                                    max_file_size: 350000,
                                    button_class: 'btn btn-info change-image',
                                    button_caption: '<span class="glyphicon glyphicon-camera"></span><span style = "margin-left: 7px;" > Change image </span>',
                                    show_powered_by: false},

                                function (error, result) { // < Callback
                                    console.log(error, result);
                                    if (typeof result != 'undefined') {
                                        window.location.href = "/users/{{ profile.user.id }}/?new_image=True";
                                    }
                                });
                    });
                </script>

                <button id="upload_widget_opener"></button>

            {% endif %}

        </div>

        <div class="col-xs-8" style="font-size: 16pt;">
            <span style="font-weight: bold;">About {{ profile.jos_name }}</span>

            {% if edit %}
                <a class="btn btn-info pull-right" style="margin-right: 17px; outline: none; text-decoration: none;"
                   href="{% url "josprofile_edit" request.user.id %}?field_to_edit=about_me">
                   <span class="glyphicon glyphicon-pencil"></span>
                   <span style="margin-left: 7px;">Edit section</span>
                </a>
            {% endif %}

            <div style="{% if edit %}outline: 3px dashed #28a4c9;{% endif %} line-height: 1.4; margin-top: 5px;">
                {{ profile.about_me | richtext_filters |safe }}
            </div>
        </div>

        <div class="col-xs-2 side-panel" style="margin-right: 0; margin-top: 30px;">

            {% if profile.user == request.user %}

                {% if edit %}

                    <a class="btn pull-right btn-default" style="background-color: #28a4c9; border: none; color: white; outline: none; width: 100px;"
                       href="{% url "josprofile" request.user.id %}">
                        {% trans "Hide edit" %}
                    </a>

                {% else %}

                    <a class="btn btn-default pull-right"
                       style="background-color: #28a4c9; border: none; color: white; outline: none; width: 100px;"
                       href="{% url "josprofile_edit" request.user.id %}">
                        {% trans "Edit mode" %}
                    </a>

                {% endif %}

                <p style="font-size: 14pt; margin-top: 50px; text-align: right;">
                    Last edit:<br>
                    <span style="color: green">{{ profile.updated | date:'m/d/y' }}</span>
                </p>

            {% else %}

                <a class="btn pull-right btn-default"
                   style="width: 150px;"
                   href="{% url 'messages_compose' %}{{ profile.user.id }}">
                    Send message
                </a>

                <a class="btn pull-right btn-default"
                   style="width: 150px; margin-top: 30px;"
                   href="{% url 'josmembers_list' %}/?add_favorite={{ profile.user.id }} ">
                    Make favorite
                </a>

            {% endif %}

            {% if profile.user == request.user and request.user.is_staff %}

                <a class="btn btn-default pull-right" style="margin-top: 30px;"
                   href="{% url "josstaff_timesheet" %}?firstname={{ user.get_short_name }}">
                    {% trans "For staff" %}
                </a>

            {% endif %}
        </div>
    </div>

{% endblock %}
