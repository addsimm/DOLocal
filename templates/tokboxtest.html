
{% extends "josstaff/staff_base.html" %}
{% load i18n tz pages_tags mezzanine_tags staticfiles %}

{% block outer_breadcrumb %}{% endblock outer_breadcrumb %}

{% block all_content %}


{#chat not working#}

<style>

    .container {
        margin-top: 0;
    }

    .videoContainer {
        border: 7px solid rgb(65, 45, 120);
        height: 160px;
        margin: 0;
        padding: 0;
        width: 240px;
    }

    .nameContainer {
        color: green;
        font-family: "Open Sans", sans-serif;
        font-size: 18pt;
        margin: 0;
        padding: 10px;
        width: 240px;
    }

    .bckgrndimg {

    }

</style>

{# <span class="josinstructions">Facilitator:</span> #}

<div class="row josinstructions" style="margin-top: -50px;">

{#<input type="button" value="Signal" id="signalLink" onClick="sendSignal()">#}

    <div id="audienceContainer" class="col-xs-12" style="background-color: transparent; padding: 15px 25px;"></div>

</div>

<div id="signals"></div>

<div class="row" style="background-color: transparent;">

    <div class="col-xs-12"
         style="background-color: rgba(65, 45, 120, .2); border: 3px solid rgba(65, 45, 120, .2);">
        <div id="chat"></div>
    </div>

</div>

{# scripts #}
<script src="https://static.opentok.com/v2/js/TB.min.js" charset="utf-8"></script>
<script src="/static/js/opentok-text-chat.js"></script>
<link rel="stylesheet" href="/static/css/opentok-textchat.css"/>

<script charset="utf-8">
    LayoutVideoContainer();

    var connectionCount = 0;

    function connectToSession() {
        var name = '{{ request.user.JOSProfile.jos_name }}' + ',' +
        '{{ request.user.JOSProfile.profile_image_idstr }}';
        var publisher_jos_name = name.split(',')[0];
        var publisher_background_image = name.split(',')[1];
        var bckgrndImageURL = ' ';
        if (publisher_background_image == "noimage1") {
            bckgrndImageURL = 'https://www.joinourstory.com/static/img/coming-soon-profile.png';
        } else {
            bckgrndImageURL = 'https://res-4.cloudinary.com/desg88u7l/image/upload/' + publisher_background_image;
        }


        var apiKey = '45616422';
        var sessionID = '{{ session_id }}';
        var token = '{{ token }}';
        var mic = false;
        var cam = false;

        var session = OT.initSession(apiKey, sessionID);

        // Setup text chat
        var chat = new OTSolution.TextChat.ChatWidget({
            session: session,
            container: '#chat',
            senderAlias: publisher_jos_name
        });

        console.log("OT.checkSystemRequirements " + OT.checkSystemRequirements());

        // Log input devices
        OT.getDevices(function (error, devices) {
            console.log("get devices");
            if (!error) {
                inputDevices = devices;

                for (var i = 0; i < inputDevices.length; i++) {
                    switch (inputDevices[i].kind) {
                        case "audioInput":
                            mic = true;
                            break;
                        case "videoInput":
                            cam = true;
                            break;
                    }
                }
                // console.log("1 Mics: " + mic);
                // console.log("1 Cams: " + cam);

            } else {
                console.log("getDevices error: " + error);
            }
        });

        if (OT.checkSystemRequirements() == 1) {

            // Session connect
            session.connect(token, function (error) {

                if (!error) {
                    console.log("2. session.connect success");
                    // console.log("2 Mics: " + mic);
                    // console.log("2 Cams: " + cam);

                    // Find open video box
                    var vidBox = getNextEmptyVidBox(divIdName=publisher_jos_name, publish=true);

                    var publisherOptions = {
                        audioLevelDisplayMode: "on",
                        buttonDisplayMode: 'on',
                        frameRate: 15,
                        height: 160,
                        name: name,
                        width: 240
                    };

                    // initPublisher
                    var publisher = OT.initPublisher(vidBox, publisherOptions, function(error) {
                        if (error) {
                            console.log(error);
                        } else {
                            console.log("Publisher initialized.");
                        }
                    });

                    // Session publish
                    session.publish(publisher);

                    if (cam != true) {
                        $(vidBox).html("<img style='height: 140px; padding: 5px 0;' src=" + bckgrndImageURL + ">");
                    }

                    publisher.on({
                        accessAllowed: function (event) {
                            console.log('accessAllowed');
                        },

                        accessDenied: function (event) {
                            // The user has denied access.
                            console.log('accessDenied');
                        },

                        accessDialogClosed: function (event) {
                            console.log('accessDialogClosed');
                        },

                        accessDialogOpened: function (event) {
                            // The Allow/Deny dialog box is opened.
                            console.log('accessDialogOpened');
                        },

                        streamCreated: function (event) {
                            console.log('publisher streamCreated');
                        },

                        streamDestroyed: function (event) {
                            console.log('publisher streamDestroyed');
                        }
                    });

                } else {

                    console.log("session.connect error: ", error.code, error.message);
                }
            });

        } else {

            // checkSystemRequirements error
            alert("Sorry, there is a problem - please call us; then,  say 'RTC' is not working. Thanks!");
        }

        function getNextEmptyVidBox(divIdName, publish) {
            for (c = 1; c < 13; c++) {
                var testID = '#vid_' + c + '_empty';
                if ($(testID).length) {
                    nextEmptyID = testID.substr(1);
                    break;
                }
            }
            var vidBox = document.getElementById(nextEmptyID);
            vidBox.id = nextEmptyID.slice(0, -5) + divIdName.slice(0, -1).split(' ').join('_');
            if (publish == true) {
                vidBox.style.zIndex = 10;
            }

            var nameBoxID = 'name_' + vidBox.id.split('_')[1].toString();
            var nameBox = document.getElementById(nameBoxID);
            nameBox.innerHTML = divIdName;

            var particBox = document.getElementById('box_' + vidBox.id.split('_')[1].toString());
            $(particBox).removeClass('hidden');

            return vidBox
        }

        function streamCreatedHandler(e) {
            // // Find open video slot
            var subscriber_jos_name = e.stream.name.split(',')[0];
            var subscriber_background_image = e.stream.name.split(',')[1];

            var bckgrndImageURL = ' ';
            if (subscriber_background_image == "noimage1") {
                bckgrndImageURL = 'https://www.joinourstory.com/static/img/coming-soon-profile.png';
            } else {
                bckgrndImageURL = 'https://res-4.cloudinary.com/desg88u7l/image/upload/' + subscriber_background_image;
            }

            var vidBox = getNextEmptyVidBox(divname = subscriber_jos_name, publish = false);

            var subscribeProperties = {
                height: 160,
                width: 240,
                frameRate: 15
            };

            // Subscribe to stream that caused event
            var subscriber = session.subscribe(
                    e.stream, vidBox, subscribeProperties, function (error) {
                        if (error) {
                            console.log(error);
                        } else {
                            console.log('Stream subscribed: ' + e.stream.name);
                        }
                    });

            var stream_video = e.stream.hasVideo;
            console.log("stream_video: " + stream_video);
            if (stream_video != true) {
                $(vidBox).html("<img style='height: 140px; padding: 5px 0;' src=" + bckgrndImageURL + ">");
            }
        }

        session.on({

            connectionCreated: function (event) {
                connectionCount++;
                if (event.connection.connectionId != session.connection.connectionId) {
                    console.log('Another client connected. active connections: ' + connectionCount);
                } else {
                    console.log('4. This client connected. active connections: ' + connectionCount);
                }
            },

            connectionDestroyed: function connectionDestroyedHandler(event) {
                connectionCount--;
                console.log('connection destroyed. active connections: ' + connectionCount);
            },

            sessionConnected: function sessionConnected(event) {
                console.log('3. session connected');
            },

            sessionDisconnected: function sessionDisconnectHandler(event) {
                console.log('sessionDisconnected');
                // if (event.reason == "networkDisconnected") {alert("Your network connection terminated.")}
            },

            streamCreated: function (event) {
                console.log('Stream Created: ' + event.stream.name);
                streamCreatedHandler(event);
            },

            streamDestroyed: function (event) {
                console.log('Stream destroyed: ' + event.stream.name);
                event.preventDefault();
                reclaimSlot(event);
            },

            streamPropertyChanged: function (event) {
                switch (event.changedProperty) {
                    case "hasAudio":
                        console.log("streamPropertyChanged hasAudio: " + event.newValue);
                        break;
                    case "hasVideo":
                        console.log("streamPropertyChanged hasVideo: " + event.newValue);
                        break;
                    case "videoDimensions" :
                        console.log(" streamPropertyChangedorientation change:" + event.newValue);
                        break;
                    case "quality":
                        for (var i in event.newValue) {
                            console.log("streamPropertyChanged index[" + i + "]: " + event.newValue[i])
                        }
                        break;
                }
            },

{#            signal: function (event) {#}
{#                // Signal received#}
{#                console.log("Signal received: " + event.data);#}
{##}
{#            }#}
        });
    }

    connectToSession();

    // Archive ???

    // Start Archive
    function startArchiveSession() {
        alert("start");
        // Ajax call
        //https://api.opentok.com/v2/partner/<api_key>/archive
        $.ajax({
            url: 'https://api.opentok.com/v2/partner/45592942/archive',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            headers: 'X-TB-PARTNER-AUTH: 45592942:92c49242824dd9e83890c8c282da3628e8d56752',
            data: {
                "sessionId": "1_MX40NTU5Mjk0Mn5-MTQ2NzExNjQzNzM3Nn4wUTUzNnNURHlLQmdKWjNPUTVMdlNSSkd-fg",
                "hasAudio": true,
                "hasVideo": true,
                "name": "sabir",
                "outputMode": "individual",
            },
            processData: false,
            success: function (data) {
                console.log("success" + data);
                console.log(JSON.stringify(data));
            },
            error: function (errorThrown) {
                console.log("Error" + JSON.stringify(errorThrown));
            }
        });


        hide('startArchive');
        show('stopArchive');
    }

    // Stop archive
    function stopArchiveSession() {
        $.ajax({
            url: 'https://api.opentok.com/v2/partner/45592942/archive/arch_id/stop',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            headers: 'X-TB-PARTNER-AUTH: 45592942:92c49242824dd9e83890c8c282da3628e8d56752',
            processData: false,
            success: function (data) {
                console.log("success" + data);
                console.log(JSON.stringify(data));
            },
            error: function (errorThrown) {
                console.log("Error" + JSON.stringify(errorThrown));
            }
        });

        show('startArchive');
        hide('stopArchive');
    }



    // ----------------
    // Layout functions
    // ----------------

    // Layout particpant videos
    function LayoutVideoContainer() {

        for (i = 0; i < 4; i++) {
            var rowI = document.createElement('div');
            $(rowI).addClass('row');
            rowI.id = 'row_' + i;
            document.getElementById('audienceContainer').appendChild(rowI);

            for (j = 1; j < 5; j++) {
                var newParticBox = document.createElement('div');
                $(newParticBox).addClass('col-xs-3 hidden text-center');
                newParticBox.id = 'box_' + (i * 4 + j);

                var newVidBox = document.createElement('div');
                newVidBox.id = 'vid_' + (i * 4 + j) + '_empty';
                $(newVidBox).addClass('row videoContainer').innerHTML = newVidBox.id;
                newParticBox.appendChild(newVidBox);

                var newNameBox = document.createElement('div');
                newNameBox.id = 'name_' + (i * 4 + j);
                $(newNameBox).addClass('row text-center nameContainer').innerHTML = newNameBox.id;
                newParticBox.appendChild(newNameBox);

                rowI.appendChild(newParticBox);
            }
        }
    }

    function reclaimSlot(e) {
        var reclaimedID = ' ';
        var subscriber_jos_name = e.stream.name.split(',')[0];
        subscriber = subscriber_jos_name.slice(0, -1).split(' ').join('_');
        for (c = 1; c < 13; c++) {
            var testID = '#vid_' + c + '_' + subscriber;
            if ($(testID).length) {
                reclaimedID = testID.substr(1);
                break;
            }
        }

        var position = reclaimedID.split('_')[1].toString();

        particBox = document.getElementById('box_' + position);
        $(particBox).empty().addClass('hidden');

        vidBox = document.createElement('div');
        $(vidBox).addClass('row videoContainer');
        vidBox.id = 'vid_' + position + '_empty';
        vidBox.innerHTML = vidBox.id;
        particBox.appendChild(vidBox);

        var nameBox = document.createElement('div');
        $(nameBox).addClass('row text-center nameContainer');
        nameBox.id = 'name_' + position;
        nameBox.innerHTML = nameBox.id;
        particBox.appendChild(nameBox);
    }

</script>

{% endblock all_content %}

Test for VIDEO DISABLED:
    subscriber.on("videoDisabled", function (event) {
    You may want to hide the subscriber video element:
    domElement = document.getElementById(subscriber.id);
    domElement.style["visibility"] = "hidden";

TOGGLE AUDIO / VIDEO: subscriber.subscribeToAudio(false); // audio off

Events:

subscriber.on({
    audioLevelUpdated
    destroyed
    disconnected
    videoDimensionsChanged
    videoDisabled
    videoDisableWarning
    videoDisableWarningLifted
    videoEnabled Media Router resumes sending video.

exceptions:
    1004    Authentication error
    1005    Invalid Session ID
    1006    Connect Failed
    1007    Connect Rejected
    1008    Connect Time-out
    1009    Security Error
    1010    Not Connected
    1011    Invalid Parameter
    1013    Connection Failed
    1014    API Response Failure
    1026    Terms of Service Violation: Export Compliance
    1500    Unable to Publish
    1520    Unable to Force Disconnect
    1530    Unable to Force Unpublish
    1535    Force Unpublish on Invalid Stream
    2000    Internal Error
    2010    Report Issue Failure
