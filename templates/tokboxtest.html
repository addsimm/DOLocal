
{% extends "josstaff/staff_base.html" %}
{% load i18n tz pages_tags mezzanine_tags staticfiles %}


{% block all_content %}

{{ block.super }}

To do: manage sessions, format windows, place moderator at top
    opentok.js-text-chat


    <div class="row josinstructions" style="margin-top: 50px; background-color: red;">

        <div class="col-xs-8" style="background-color: orange;">

            <div id="other_participants_div" class="row"
                 style="background-color: pink;>
             margin-top: 100px;">
                Participants:
            </div>

        </div>

        <div class="col-xs-4" style="background-color: lightgreen;">

            <div id="facilitator_div" class="row"
                 style="background-color: rgb(65,45,120); color: white;">
                Facilitator:
            </div>

            <div id="my_video_div" class="row"
                 style="background-color: yellow;
                 margin-top: 50px;">
                {{ request.user.JOSProfile.jos_name }} (My video):
            </div>

        </div>
    </div>


<script src="https://static.opentok.com/v2/js/opentok.min.js" charset="utf-8"></script>

<script charset="utf-8">
    var session;
    var connectionCount = 0;

    function connect() {
        var name = '{{ request.user.JOSProfile.jos_name }}';
        var apiKey = '45616422';
        var sessionId = '{{ session_id}}';
        var token = '{{ token }}';
        var element_id = 'other';
        var subContainer = document.createElement('div');

        if (OT.checkSystemRequirements() == 1) {
            var session = OT.initSession(apiKey, sessionId);
        } else {
            alert("The client does not support WebRTC.");
        }


        session.on({

            streamCreated: function (event) {

                if (event.stream.name == 'Adam S.') {
                    element_id = 'facilitator_div';
                } else {
                    element_id = 'other_participants_div';
                }

                subContainer.id = 'stream-' + event.stream.streamId;
                subContainer.innerHTML = event.stream.name + '<br><br>';
                // $(subContainer).addClass('text-center');

                document.getElementById(element_id).appendChild(subContainer);
                var subscriberProperties = {
                    insertMode: 'append'
                    // AUDIO ONLY:  subscribeToAudio: true, subscribeToVideo: false
                };

                // Subscribe to stream that caused event, put inside container
                var subscriber = session.subscribe(event.stream,
                        subContainer,
                        subscriberProperties,
                        function (error) {
                            if (error) {
                                console.log(error);
                            } else {
                                console.log('Subscriber added.');
                            }
                        });

                // Test for VIDEO DISABLED
                // subscriber.on("videoDisabled", function (event) {
                    // You may want to hide the subscriber video element:
                    // domElement = document.getElementById(subscriber.id);
                    // domElement.style["visibility"] = "hidden";

                    // You may want to add or adjust other UI.
                // });
            },

            sessionDisconnected: function sessionDisconnectHandler(event) {
                // The event is defined by the SessionDisconnectEvent class
                if (event.reason == "networkDisconnected") {
                    alert("Your network connection terminated.")
                }
            },

            connectionCreated: function (event) {
                connectionCount++;
                if (event.connection.connectionId != session.connection.connectionId) {
                    console.log('Another client connected. ' + connectionCount + ' total.');
                }
            },

            connectionDestroyed: function connectionDestroyedHandler(event) {
                connectionCount--;
                console.log('A client disconnected. ' + connectionCount + ' total.');
            }
        });

        session.connect(token, function (error) {
            if (!error) {
                console.log("Connected to the session.");
                var publisher = OT.initPublisher('my_video_div', {
                    name: name,
                    insertMode: 'append'
                    // AUDIO ONLY:  videoSource: null
                });

                session.publish(publisher);
            } else {
                console.log("Error connecting: ", error.code, error.message);
            }
        });
    }

    connect();

    // TOGGLE AUDIO / VIDEO: subscriber.subscribeToAudio(false); // audio off
    // CAMERA ACCESS ALERTS
    {#publisher.on({#}
    {#    accessDialogOpened: function (event) {#}
    {#        // The Allow/Deny dialog box is opened.#}
    {#        // MESSAGE#}
    {#        alert('Please allow access to camera.');#}
    {#    },#}
    {#    accessDialogClosed: function (event) {#}
    {#        // The Allow/Deny dialog box is closed.#}
    {#        alert('What happnened?')#}
    {#    },#}
    {#    accessAllowed: function (event) {#}
    {#        // The user has granted access to the camera and mic.#}
    {#        alert('Access to camera.');#}
    {#    },#}
    {#    accessDenied: function accessDeniedHandler(event) {#}
    {#        // The user has denied access to the camera and mic.#}
    {#        // NOT WORKING#}
    {#        alert('You have denied camera access.');#}
    {#    }#}

</script>

{% endblock all_content %}