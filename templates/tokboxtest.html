
{% extends "josstaff/staff_base.html" %}
{% load i18n tz pages_tags mezzanine_tags staticfiles %}


{% block all_content %}

{{ block.super }}

To do: manage sessions, format windows, place moderator at top

<div class="row" style="margin-top: 50px; background-color: lightblue;">

    <div class="col-xs-4 col-xs-offset-2" style="background-color: lightgreen;">

        Live video test:

        <div id="publish" class="row"
             style="background-color: pink;>
             margin-top: 100px;">
            Publisher:
        </div>

        <div id="subscribers" class="row"
             style="background-color: yellow;
             margin-top: 100px;">
            Subscribers:
        </div>

    </div>

</div>


<script src="https://static.opentok.com/v2/js/opentok.min.js" charset="utf-8"></script>

<script charset="utf-8">
    var session;
    var connectionCount = 0;

    function connect() {
        var name = '{{ request.user.JOSProfile.jos_name }}';
        var apiKey = '45616422';
        var sessionId = '{{ session_id}}';
        var token = '{{ token }}';
        if (OT.checkSystemRequirements() == 1) {
            var session = OT.initSession(apiKey, sessionId);
        } else {
            alert("The client does not support WebRTC.");
        }


        session.on({
            streamCreated: function (event) {
                var subContainer = document.createElement('div');
                subContainer.id = 'stream-' + event.stream.streamId;
                document.getElementById('subscribers').appendChild(subContainer);
                var subscriberProperties = {
                    name: name,
                    insertMode: 'append'
                    // AUDIO ONLY:  subscribeToAudio: true, subscribeToVideo: false
                };

                subscriber.setStyle(
                        "nameDisplayMode", on,
                        "buttonDisplayMode", on,
                        'backgroundImageURI',
                        "/static/img/coming-soon-profile.png",
                        "showControls", true,
                        "audioLevelDisplayMode", on
                );

                // Subscribe to stream that caused event, put inside container
                var subscriber = session.subscribe(event.stream,
                        'subContainer',
                        subscriberProperties,
                        function (error) {
                            if (error) {
                                console.log(error);
                            } else {
                                console.log('Subscriber added.');
                            }
                        });

                // Test for VIDEO DISABLED
                subscriber.on("videoDisabled", function (event) {
                    // You may want to hide the subscriber video element:
                    // domElement = document.getElementById(subscriber.id);
                    // domElement.style["visibility"] = "hidden";

                    // You may want to add or adjust other UI.
                });
            },

            sessionDisconnected: function sessionDisconnectHandler(event) {
                // The event is defined by the SessionDisconnectEvent class
                if (event.reason == "networkDisconnected") {
                    alert("Your network connection terminated.")
                }
            },

            connectionCreated: function (event) {
                connectionCount++;
                if (event.connection.connectionId != session.connection.connectionId) {
                    console.log('Another client connected. ' + connectionCount + ' total.');
                }
            },

            connectionDestroyed: function connectionDestroyedHandler(event) {
                connectionCount--;
                console.log('A client disconnected. ' + connectionCount + ' total.');
            }
        });

        session.connect(token, function (error) {
            if (!error) {
                console.log("Connected to the session.");
                var publisher = OT.initPublisher('publish', {
                    name: name,
                    insertMode: 'append'
                    // AUDIO ONLY:  videoSource: null
                });

                publisher.setStyle(
                        "nameDisplayMode", on,
                        "buttonDisplayMode", on,
                        'backgroundImageURI',
                        "/static/img/coming-soon-profile.png",
                        "showControls", true,
                        "audioLevelDisplayMode", on
                );

                https://vimeo.com/173777838

                // CAMERA ACCESS ALERTS
                {#publisher.on({#}
                {#    accessDialogOpened: function (event) {#}
                {#        // The Allow/Deny dialog box is opened.#}
                {#        // MESSAGE#}
                {#        alert('Please allow access to camera.');#}
                {#    },#}
                {#    accessDialogClosed: function (event) {#}
                {#        // The Allow/Deny dialog box is closed.#}
                {#        alert('What happnened?')#}
                {#    },#}
                {#    accessAllowed: function (event) {#}
                {#        // The user has granted access to the camera and mic.#}
                {#        alert('Access to camera.');#}
                {#    },#}
                {#    accessDenied: function accessDeniedHandler(event) {#}
                {#        // The user has denied access to the camera and mic.#}
                {#        // NOT WORKING#}
                {#        alert('You have denied camera access.');#}
                {#    }#}

                session.publish(publisher);
            } else {
                console.log("Error connecting: ", error.code, error.message);
            }
        });
    }

    connect();

    // TOGGLE AUDIO / VIDEO: subscriber.subscribeToAudio(false); // audio off

</script>

{% endblock all_content %}