
{% extends "josstaff/staff_base.html" %}
{% load i18n tz pages_tags mezzanine_tags staticfiles %}

{% block all_content %}

<style>

    .videoContainer {
        border: 7px solid rgb(65, 45, 120);
        margin-top: 5px;
        margin-left: 25px;
        width: 240px;
        height: 160px;
        padding: 0;
    }

    .nameContainer {
        color: green;
        font-family: "Open Sans", sans-serif;
        font-size: 18pt;
        margin-left: 25px;
        width: 240px;
        padding: 10px;
    }

</style>


<span class="josinstructions">Facilitator:</span>
<div class="row" style="background-color: green;">

    <div id="facilitator_div"
         class="col-xs-3 videoContainer"
         style="background-color: rgb(65,45,120); margin-left: 0;">

    </div>

</div>

<div class="row josinstructions" style="margin-top: 15px; background-color: red;">

    <div id="audienceContainer" class="col-xs-12" style="background-color: pink; padding: 15px 45px;">

    </div>

</div>

<div id="chat" style="margin-top: 50px; background-color: lightblue;">

</div>

{#<script src="static/js/OT_LayoutContainer.js" type="text/javascript" charset="utf-8"></script>#}
<script src="https://static.opentok.com/v2/js/opentok.min.js" charset="utf-8"></script>
<script src="static/js/opentok-text-chat.js"></script>
<link rel="stylesheet" href="static/css/opentok-textchat.css"/>

<script charset="utf-8">

    var connectionCount = 0;

    function connectThis() {
        var name = '{{ request.user.JOSProfile.jos_name }}';
        var apiKey = '45616422';
        var sessionID = '{{ session_id}}';
        var token = '{{ token }}';
        var session = OT.initSession(apiKey, sessionID);

        for (i = 0; i < 3; i++) {

            var rowI = document.createElement('div');
            $(rowI).addClass('row');
            rowI.id = 'row_' + i ;
            document.getElementById('audienceContainer').appendChild(rowI);

            for (j = 1; j < 5; j++) {
                var colJ = document.createElement('div');
                $(colJ).addClass('col-xs-3 text-center videoContainer');
                colJ.id = 'pos_' + (i * 4 + j)+'_empty';
                colJ.innerHTML = colJ.id;
                rowI.appendChild(colJ);
            }

            for (j = 1; j < 5; j++) {
                var colJName = document.createElement('div');
                $(colJName).addClass('col-xs-3 text-center nameContainer');
                colJName.id = 'name_' + (i * 4 + j);
                colJName.innerHTML = colJName.id;
                rowI.appendChild(colJName);
            }
        }

        var chat = new OTSolution.TextChat.ChatWidget({
            session: session,
            container: '#chat'
        });

        if (OT.checkSystemRequirements() == 1) {

            session.connect(token, function (error) {
                if (!error) {
                    console.log("Connected to the session.");


                    var nextEmptyID = ' ';
                    for (c = 1; c < 13; c++) {
                        var testID = '#pos_' + c + '_empty';
                        //alert(testID + ": " + $(testID).length);
                        if ($(testID).length) {
                            nextEmptyID = testID.substr(1);
                            break;
                        }
                    }

                    // alert('publish: ' + nextEmptyID);

                    var subContainer = document.getElementById(nextEmptyID);
                    subContainer.id = nextEmptyID.slice(0, -5) + name;
                    subContainer.style.zIndex = 10;
                    var publisher = OT.initPublisher(subContainer, {
                        name: name,
                        height: 160,
                        width: 240
                        // AUDIO ONLY:  videoSource: null
                    });
                    session.publish(publisher);
                } else {
                    console.log("Error connecting: ", error.code, error.message);
                }
            });
        } else {
            alert("Please call us and say: my browser doesn't have 'WebRTC'");
        }

        session.on({

            connectionDestroyed: function connectionDestroyedHandler(event) {
                connectionCount--;
                console.log('connection destroyed; ' + connectionCount + ' total.');
            },

            streamDestroyed: function (event) {
                event.preventDefault();
                // alert("Stream destroyed: " + event.stream.name);

                var reclaimedID = ' ';
                subscriber = event.stream.name.slice(0, -1).split(' ').join('_');
                for (c = 1; c < 13; c++) {
                    var testID = '#pos_' + c + '_' + subscriber;
                    // console.log('Test id:' + testID + " " + $(testID).length);
                    // alert(testID + ": " + $(testID).length);
                    if ($(testID).length) {
                        reclaimedID = testID.substr(1);
                        break;
                    }
                }
                // alert('reclaimedID :' + reclaimedID);
                subContainer = document.getElementById(reclaimedID);
                $(subContainer).empty().removeClass();
                $(subContainer).addClass('col-xs-3 text-center videoContainer');
                subContainer.id = reclaimedID.replace(event.stream.name
                        .slice(0,-1)
                        .split(' ')
                        .join('_'), 'empty');

            },

            streamCreated: function (event) {

                var nextEmptyID = ' ';
                for (c = 1; c < 13; c++) {
                    var testID = '#pos_' + c + '_empty';
                    //alert(testID + ": " + $(testID).length);
                    if ($(testID).length) {
                        nextEmptyID = testID.substr(1);
                        break;
                    }
                }

                // alert('subscribe: ' + nextEmptyID);

                var subContainer = document.getElementById(nextEmptyID);

                var subscriberProperties = {
                    // AUDIO ONLY:  subscribeToAudio: true, subscribeToVideo: false
                    height: 160,
                    width: 240
                };

                // Subscribe to stream that caused event, put inside container
                var subscriber = session.subscribe(
                        event.stream, subContainer, subscriberProperties, function (error) {
                            if (error) {
                                console.log(error);
                            } else {
                                console.log('Stream subscribed');
                            }
                        });

                subContainer.id = nextEmptyID.slice(0, -5) + event.stream.name.slice(0, -1).split(' ').join('_');

            },

            sessionDisconnected: function sessionDisconnectHandler(event) {
                // The event is defined by the SessionDisconnectEvent class
                if (event.reason == "networkDisconnected") {
                    alert("Your network connection terminated.")
                }
            },

            connectionCreated: function (event) {
                connectionCount++;
                if (event.connection.connectionId != session.connection.connectionId) {
                    console.log('Another client connected. ' + connectionCount + ' total.');
                } else {
                    console.log('I connected. ' + connectionCount + ' total.');
                }

            }
        });
    }

connectThis();


</script>

{% endblock all_content %}

Test for VIDEO DISABLED
subscriber.on("videoDisabled", function (event) {
You may want to hide the subscriber video element:
domElement = document.getElementById(subscriber.id);
domElement.style["visibility"] = "hidden";

You may want to add or adjust other UI.


TOGGLE AUDIO / VIDEO: subscriber.subscribeToAudio(false); // audio off

CAMERA ACCESS ALERTS


publisher.on({
    accessDialogOpened: function (event) {
        // The Allow/Deny dialog box is opened.
        // MESSAGE
        alert('Please allow access to camera.');
    },
    accessDialogClosed: function (event) {
        // The Allow/Deny dialog box is closed.
        alert('What happnened?')
    },
    accessAllowed: function (event) {
        // The user has granted access to the camera and mic.
        alert('Access to camera.');
    },
    accessDenied: function accessDeniedHandler(event) {
        // The user has denied access to the camera and mic.
        // NOT WORKING
        alert('You have denied camera access.');
    }

