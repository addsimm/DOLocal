{% comment %}
   humanize:
      For the "apnumber" filter, to display "two" instead of
      "2". Requries 'django.contrib.humanize' in INSTALLED_APPS

   static:
      To access the public static file directory, without having to hard
      code urls.
{% endcomment %}
{% load humanize static %}
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>Color Like</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width"/>

    <style>

        table {
            border: 1px solid #000;
            border-spacing: 0px;
            background-color: #EEE;
            border-collapse: collapse;
        }

        td {
            text-align: center;
            vertical-align: middle;
            padding: 4px;
            border: 1px solid #000;
        }

         .button_liked {
            background-color: pink;
        }

        .button_unliked {
            background-color: white;
        }

    </style>

</head>
<body>

<div class="search_section">
    <form id="search_colors_form_id" method="get" action="{% url 'color_list' %}">
        {# csrf_token is not needed #}

        <input type="text" id="search_text" name="search_text">
        <input id="id_pic_submit_button" type="submit" value="Search for color"/>
        <p>(Requires {{ MIN_SEARCH_CHARS|apnumber }} or more characters)</p>

    </form>

    {% if  search_text|length >= MIN_SEARCH_CHARS %}

        <p><b>Searching for &quot;<code>{{ search_text }}</code>&quot;:</b>

            {% if  color_search_results.count > 0 %}
                </p>
                <ul>
                    {% for  color in color_search_results %}
                        <li>{{ color.name }}</li>
                    {% endfor %}
                </ul>

            {% else %}
                <i>No results</i></p>

            {% endif %}

    {% endif %}
</div>

<div class="content_section">
    <h1>Color Liker</h1>

    {% if  colors.count == 0 %}
        <p><i>There are no colors in the database.</i></p>
    {% else %}

        <table>
            <tr>
                <th colspan="2">Color</th>
                <th>Fav.?</th>
            </tr>
            <!--
               The table cell is in this main template, the button in
               it, is in the "include"d sub-template. The button
               sub-template is used by the below for-loop, and also by
               the toggle_color_like view, which is called by Ajax.

               Ajax calls Django, which renders the sub-template and
               feeds it back to Ajax, which then replaces the current
               button/sub-template with the new one.

               (The data-color_id is how the id is passed to JQuery)
            -->
            {% for  color in colors %}

                <tr>
                    <td class="td__color_color" style="background-color: {{ color.name }}; width: 30px;"></td>
                    <td class="td__color_name">{{ color.name }}</td>

                    <td id="toggle_color_like_cell_{{ color.id }}"
                        class="td__toggle_color_like_button"
                        data-color_id="{{ color.id }}">

                        {% include "color_liker/color_like_link__html_snippet.txt" %}
                    </td>
                </tr>

            {% endfor %}
        </table>
    {% endif %}
</div>

<script src="{% static "mezzanine/js/"|add:settings.JQUERY_FILENAME %}"></script>
<script type='text/javascript'
        src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
<script language="javascript">
    /* Before our JavaScript, the url to toggle the like) needs to be set; its located in color_liker.urls.
     Since an id must be provided to the Django url, give it a bogus one, then immediately lop it off */
    var LIKE_URL_PRE_ID = "{% url 'toggle_color_like' color_id='999999' %}"
    LIKE_URL_PRE_ID = LIKE_URL_PRE_ID.substring(0, LIKE_URL_PRE_ID.length - "999999/".length);
</script>

<script language="javascript">
    /* immediately before </body> tag and after JQuery and Underscore.js.
     Milliseconds to ignore clicks on the *same* like, after a button *that was not ignored* was clicked. */
    var MILLS_TO_IGNORE_LIKES = 500;
    /** Executes a like click. */
    var processLike = function () {

        //In this scope, "this" is the clicked button; "this" in processServerResponse is *not* the clicked button
        var $button_just_clicked_on = $(this);

        //The value of the "data-color_id" attribute.
        var color_id = $button_just_clicked_on.data('color_id');

        var processServerResponse = function (sersverResponse_data,
                                              textStatus_ignored,
                                              jqXHR_ignored) {

            alert("sf sersverResponse_data='" + sersverResponse_data + "'," +
                    " textStatus_ignored='" + textStatus_ignored + "'," +
                    " jqXHR_ignored='" + jqXHR_ignored + "'," +
                    " color_id='" + color_id + "'");

            $('#toggle_color_like_cell_' + color_id).html(sersverResponse_data);
        }

        var config = {
            url: LIKE_URL_PRE_ID + color_id + '/',
            dataType: 'html',
            success: processServerResponse
            //Should also have a "fail" call as well.
        };
        $.ajax(config);
    };

    /** The Ajax "main" function. Attaches the listeners to the elements on page load,
     each of which only take effect every MILLS_TO_IGNORE_LIKES seconds.

     This protection is only against a single user pressing buttons as fast as they can. This is in no way a
     protection against a real DDOS attack, of which almost 100% bypass the client (browser)
     (they instead directly attack the server).

    The protection is implemented via Underscore.js' debounce function:
     - http://underscorejs.org/#debounce

     Using this only requires importing underscore-min.js. underscore-min.map
     is not needed. */

    $(document).ready(function () {
        /*
         There are many buttons having the class td__toggle_color_like_button.
         This attaches a listener to *every one*. Calling this again would attach a *second* listener
         to every button, meaning each click would be processed twice.
         */
        $('.td__toggle_color_like_button')
                .click(
                        _.debounce(processLike,
                                   MILLS_TO_IGNORE_LIKES,
                                   true)
                );

        /*
         Warning: Placing the true parameter outside of the debounce call:

         $('#color_search_text').keyup(_.debounce(processSearch,
         MILLS_TO_IGNORE_SEARCH), true);

         results in "TypeError: e.handler.apply is not a function".
         */
    });

</script>
</body>
</html>