<html>
<body>
<script>

    function adjustVolume($audio, to) {
        if (!$audio) {
            return;
        }

        clearTimeout(audioTimeouts[$audio.id]);

        $audio.volume = $audio.volume < to ? $audio.volume += 0.05 : $audio.volume -= 0.05;

        if (Math.abs($audio.volume - to) > 0.05) {
            audioTimeouts[$audio.id] = setTimeout(function () {
                adjustVolume($audio, to);
            }, 50);
        }
    }

    function adjustAllVolume(to) {
        for (i in peer_audios) {
            peer_audios[i].volume = to;
            adjustVolume(peer_audios[i], to);
        }
    }

    // Chat function
    $msg.onkeydown = function (e) {
        if (!e.altKey && e.keyCode === 13 && mediaOK !== null) {
            if (online) {
                if ($msg.value === '/clear') {
                    localStorage.clear();
                    $chatbox.innerHTML = '';
                }
                else if ($msg.value.substr(0, 6) === '/join ') {
                    window.open(location.origin + location.pathname + '#' + $msg.value.substr(6), $msg.value.substr(6));
                }
                else if ($msg.value === '/mute') {
                    skylink.muteStream({audioMuted: true});
                    muted = true;
                    capture();
                }
                else if ($msg.value === '/unmute') {
                    skylink.muteStream({audioMuted: false});
                    muted = false;
                    capture();
                }
                else if ($msg.value.substr(0, 7) === '/share ') {
                    getPicture($msg.value.substr(7), function (error, url) {
                        if (error) {
                            addMessage(error, 'bot');
                        }
                        else {
                            skylink.sendP2PMessage("![powered by Flickr](" + url + ")");
                            setTimeout(function () {
                                $chatcontainer.scrollTop = $chatcontainer.scrollHeight;
                            }, 500);
                        }
                    });
                }
                else {
                    skylink.sendP2PMessage($msg.value);
                }
            }
            else if (!user.name) {
                user.name = $msg.value.replace('\n', '').trim();
                skylink.joinRoom();
            }
            $msg.value = '';
            $msg.select();

            return false;
        }
    }






    /**
     * Get flickr photo
     */

    function getPicture(tags, cb) {
        var apiKey = "e18f2a1f-f608-44ae-8fc9-e2a42bb0278e"; // replace this with your API key

        var xhr = new XMLHttpRequest(),
                xhr1 = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                var data = JSON.parse(xhr.responseText.substring(14, xhr.responseText.length - 1));
                if (data.stat == 'ok') {
                    // get a random id from the array
                    if (!data.photos.photo.length) {
                        cb("We couldn't find a photo for this. Seperate keywords with commas.");
                    }
                    else {
                        var photo = data.photos.photo[Math.floor(Math.random() * data.photos.photo.length)];

                        // now call the flickr API and get the picture with a nice size
                        xhr1.onreadystatechange = function () {
                            if (xhr1.readyState == 4) {
                                var response = JSON.parse(xhr1.responseText.substring(14, xhr1.responseText.length - 1));
                                if (response.stat == 'ok') {
                                    var the_url = response.sizes.size[5].source;
                                    cb(null, the_url);
                                } else {
                                    cb("This didn't work out. Try other keywords.");
                                }
                            }
                        }
                        xhr1.open('GET', 'https://api.flickr.com/services/rest/?method=flickr.photos.getSizes&photo_id=' + photo.id + '&api_key=' + apiKey + '&format=json', true);
                        xhr1.send(null);
                    }
                } else {
                    cb("Flickr seems down?!");
                }
            }
        }
        xhr.open('GET', 'https://api.flickr.com/services/rest/?method=flickr.photos.search&tags=' + encodeURIComponent(tags) + '&api_key=' + apiKey + '&format=json&safe_search=1&content_type=1&sort=relevance&per_page=10', true);
        xhr.send(null);
    };

</script>

</body>
</html>
