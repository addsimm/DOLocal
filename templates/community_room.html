
{% extends "josstaff/staff_base.html" %}
{% load i18n tz pages_tags mezzanine_tags staticfiles %}

{% block outer_breadcrumb %}{% endblock outer_breadcrumb %}

{% block all_content %}

<style>

    #videoSection {
        margin-top: -65px;
        padding: 0 0 10px 0;
        border-top: 3px solid rgb(231, 209, 222);
        border-bottom: 3px solid rgb(231, 209, 222);
    }

    .particbox {
        margin-top: 35px;
    }

    .videoContainer {
        background-color: transparent;
        height: 180px;
        margin: 0;
        margin-left: 15px;
        outline: 7px solid rgb(65, 45, 120);
        padding: 0;
        width: 240px;
    }

    .nameContainer {
        color: green;
        font-family: "Open Sans", sans-serif;
        font-size: 18pt;
        margin-left: 15px;
        margin-top: 15px;
        padding: 0;
        width: 240px;
    }

    #composeContainer {

    }

    .action {
        color: #28a4c9;
        font-style: italic;
        margin-left: 80px;
    }

    .cntnt {
    }

    .usr {
        color: green;
    }

    .me {
        color: red;
    }

    .table {
        background-color: white;
        font-family: "Open Sans", sans-serif;
        margin: 0 10px;
        width: 97%;
    }

    .table > tbody > tr > td {
        border: none;
        border-top: 1px dashed rgb(65, 45, 120);
        line-height: normal;
        padding: 5px 0;
    }

    #composeSection {
    }

    td {
        border: none;
        padding: 0;
    }

    tr:hover {
        background-color: inherit;
    }

</style>

{# <span class="josinstructions">Facilitator:</span> #}

{# HTML #}
<div>
<div id="videoSection" class="row">
    <div id="audienceContainer" class="col-xs-12" style="padding: 0 0 0 25px; min-height: 250px;"></div>
</div>

<div id="messagesSection" class="row" style="background-color: rgb(231, 209, 222); padding-bottom: 15px;">
    <div id="messagesContainer"
         class="col-xs-12"
         style="margin-top: 15px;
        height: 135px;
        overflow-x: hidden;
        overflow-y: auto;">
    </div>
</div>

<div id="composeSection" class="row" style="padding-bottom: 15px; border: 3px solid rgb(231, 209, 222); ">
    <div class="col-xs-12 text-center">
        <button id='newMessageButton'
                class="btn btn-warning invisible"
                style="font-size: 14pt; width: 98%;"
                onclick="goToNewMessages()"
                disabled>
            New message - click here to scroll down
        </button>
        <table style="margin: 10px 0 0 15px;">
            <tr>
                <td style="width: 70%;">
                    <input id="composeInput" type="text"
                           style="font-size: 14pt;
                          width: 100%;
                          padding: 10px;
                          border: 3px solid rgb(65,45,120);"
                           placeholder="Add your thought to the chat!">
                </td>
                <td>
                    <button class="btn btn-default" style="margin-left: 10px;" onclick="sendMessage()">
                        Send
                    </button>
                </td>
            </tr>
        </table>
    </div>
</div>
</div>

{# Scripts #}
<script src="https://static.opentok.com/v2/js/TB.min.js" charset="utf-8"></script>
<script charset="utf-8">

    LayoutVideoContainers();

    var connectionCount = 0;

    var composeInput = document.getElementById('composeInput');
    var mc = document.getElementById('messagesContainer');
    var newMessageButton = document.getElementById('newMessageButton');

    var apiKey = '45616422';
    var sessionID = '{{ session_id }}';
    var token = '{{ token }}';
    var mic = false;
    var cam = false;

    var session = OT.initSession(apiKey, sessionID);

    function connectToSession() {
        var name = '{{ request.user.JOSProfile.jos_name }}';

        console.log("OT.checkSystemRequirements " + OT.checkSystemRequirements());

        // Log input devices
        OT.getDevices(function (error, devices) {
            console.log("1. getting devices");

            if (!error) {
                inputDevices = devices;

                for (var i = 0; i < inputDevices.length; i++) {
                    switch (inputDevices[i].kind) {
                        case "audioInput":
                            mic = true;
                            break;
                        case "videoInput":
                            cam = true;
                            break;
                    }
                }

            } else {
                console.log("getDevices error: " + error);
            }
        });

        if (OT.checkSystemRequirements() == 1) {

            // Session connect
            session.connect(token, function (error) {

                if (!error) {
                    console.log("3. session.connect success");

                    // Find open video box
                    for (c = 1; c < 13; c++) {
                        var testId = '#vid_' + c + '_empty';
                        if ($(testId).length) {
                            var nextEmptyID = testId.substr(1);
                            break;
                        }
                    }

                    console.log("nextEmptyID: " + nextEmptyID);
                    var vidBox = document.getElementById(nextEmptyID);

                    vidBox.id = nextEmptyID.slice(0, -5) + name.slice(0, -1).split(' ').join('_');

                    var nameBoxID = 'name_' + vidBox.id.split('_')[1].toString();
                    var nameBox = document.getElementById(nameBoxID);
                    nameBox.innerHTML = name;

                    var particBox = document.getElementById('box_' + vidBox.id.split('_')[1].toString());
                    $(particBox).removeClass('hidden');

                    var publisherOptions = {
                        audioFallbackEnabled: true,
                        frameRate: 15,
                        height: 180,
                        name: name,
                        resolution: "320x240",
                        showControls: true,
                        style: {
                            audioLevelDisplayMode: "on",
                            backgroundImageURI: "https://www.joinourstory.com/static/img/coming-soon-profile.png",
                            buttonDisplayMode: 'on'
                        },
                        width: 240
                    };

                    // initPublisher
                    var publisher = OT.initPublisher(vidBox, publisherOptions, function (error) {
                        if (error) {
                            console.log(error);
                        } else {
                            console.log("6. publisher initialized.");
                        }
                    });


                    // Session publish
                    session.publish(publisher);

                    publisher.on({
                        accessAllowed: function (event) {
                            console.log('5: accessAllowed');
                        },

                        accessDenied: function (event) {
                            console.log('accessDenied');
                        },

                        accessDialogClosed: function (event) {
                            console.log('accessDialogClosed');
                        },

                        accessDialogOpened: function (event) {
                            console.log('accessDialogOpened');
                        },

                        streamCreated: function (event) {
                            console.log('7: publisher streamCreated');
                        },

                        streamDestroyed: function (event) {
                            console.log('publisher streamDestroyed');
                        }
                    });

                } else {

                    console.log("session.connect error: ", error.code, error.message);
                }
            });

        } else {

            // checkSystemRequirements error
            alert("Sorry, there is a problem - please call us; then,  say 'RTC' is not working. Thanks!");
        }
    }

    session.on({

        connectionCreated: function (event) {
            connectionCount++;
            if (event.connection.connectionId != session.connection.connectionId) {
                console.log('session: another client connected. active connections: ' + connectionCount);
            } else {
                console.log('4. session: publisher client connected. active connections: ' + connectionCount);
            }
        },

        connectionDestroyed: function connectionDestroyedHandler(event) {
            connectionCount--;
            console.log('connection destroyed. active connections: ' + connectionCount);
        },

        sessionConnected: function sessionConnected(event) {
            console.log('2. session: session connected');
        },

        sessionDisconnected: function sessionDisconnectHandler(event) {
            console.log('session: session disconnected');
        },

        streamCreated: function (event) {
            console.log('session: stream created: ' + event.stream.name);
            streamCreatedHandler(event);
        },

        streamDestroyed: function (event) {
            console.log('session: stream destroyed: ' + event.stream.name);
            event.preventDefault();
            reclaimSlot(event);
        },

        streamPropertyChanged: function (event) {
            switch (event.changedProperty) {
                case "hasAudio":
                    console.log("streamPropertyChanged hasAudio: " + event.newValue);
                    break;
                case "hasVideo":
                    console.log("streamPropertyChanged hasVideo: " + event.newValue);
                    break;
                case "videoDimensions" :
                    console.log(" streamPropertyChangedorientation change:" + event.newValue);
                    break;
                case "quality":
                    for (var i in event.newValue) {
                        console.log("streamPropertyChanged index[" + i + "]: " + event.newValue[i])
                    }
                    break;
            }
        }


    });

    connectToSession();

    // Layout particpant videos
    function LayoutVideoContainers() {

        for (i = 0; i < 2; i++) {
            var rowI = document.createElement('div');
            $(rowI).addClass('row');
            rowI.id = 'row_' + i;
            document.getElementById('audienceContainer').appendChild(rowI);

            for (j = 1; j < 5; j++) {
                var pstn = (i * 4) + j;
                var newParticBox = document.createElement('div');
                $(newParticBox).addClass('col-xs-3 text-center particbox hidden');
                newParticBox.id = 'box_' + pstn;

                var videoBoxId = 'vid_' + pstn + '_empty';
                var nameBoxId = 'name_' + pstn;

                var particBoxLayout = [
                    "<div class='row'>",
                    "    <div id=" + videoBoxId + " class='videoContainer'>",
                    "    </div>",
                    "</div>",
                    '<div class="row">',
                    "   <div id=" + nameBoxId + " class='text-center nameContainer'></div>",
                    '</div>'
                ].join('\n');

                $(newParticBox).html(particBoxLayout);

                rowI.appendChild(newParticBox);
            }
        }
    }

    // stream created handler
    function streamCreatedHandler(e) {
        // // Find open video slot
        var subscriber_jos_name = e.stream.name;

        // Find open video box
        for (c = 1; c < 13; c++) {
            var testId = '#vid_' + c + '_empty';
            if ($(testId).length) {
                var nextEmptyID = testId.substr(1);
                break;
            }
        }

        var vidBox = document.getElementById(nextEmptyID);
        vidBox.id = nextEmptyID.slice(0, -5) + subscriber_jos_name.slice(0, -1).split(' ').join('_');

        var nameBoxID = 'name_' + vidBox.id.split('_')[1].toString();
        var nameBox = document.getElementById(nameBoxID);
        nameBox.innerHTML = subscriber_jos_name;

        var particBox = document.getElementById('box_' + vidBox.id.split('_')[1].toString());
        $(particBox).removeClass('hidden');

        var subscribeProperties = {
            height: 180,
            width: 240,
            frameRate: 15,
            resolution: "320x240",
        };

        // Subscribe to stream that caused event
        var subscriber = session.subscribe(
                e.stream, vidBox, subscribeProperties, function (error) {
                    if (error) {
                        console.log(error);
                    } else {
                        console.log('Stream subscribed: ' + e.stream.name);
                    }
                });
    }

    // reclaim slot
    function reclaimSlot(e) {
        var reclaimedID = ' ';
        var subscriber_jos_name = e.stream.name;
        console.log("subscriber_jos_name: " + subscriber_jos_name);
        subscriberName = subscriber_jos_name.slice(0, -1).split(' ').join('_');
        console.log("subscriberName: " + subscriberName);
        for (c = 1; c < 13; c++) {
            var testID = '#vid_' + c + '_' + subscriberName;
            if ($(testID).length) {
                reclaimedID = testID.substr(1);
                break;
            }
        }

        var pstn = reclaimedID.split('_')[1].toString();

        reParticBox = document.getElementById('box_' + pstn);
        $(reParticBox).addClass('hidden');
        var videoBoxId = 'vid_' + pstn + '_empty';
        var nameBoxId = 'name_' + pstn;

        var particBoxLayout = [
            "<div class='row'>",
            "    <div id=" + videoBoxId + " class='videoContainer'>",
            "    </div>",
            "</div>",
            '<div class="row">',
            "   <div id=" + nameBoxId + " class='text-center nameContainer'></div>",
            '</div>'
        ].join('\n');

        $(reParticBox).html(particBoxLayout);
    }



</script>

{% endblock all_content %}

/*
signal: function (event) {
// Signal received
console.log("Signal received: " + event.data);

}
*/

<div>
// Archive ???

    // Start Archive
    function startArchiveSession() {
        alert("start");
        // Ajax call
        //https://api.opentok.com/v2/partner/<api_key></api_key>/archive
        $.ajax({
            url: 'https://api.opentok.com/v2/partner/45592942/archive',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            headers: 'X-TB-PARTNER-AUTH: 45592942:92c49242824dd9e83890c8c282da3628e8d56752',
            data: {
                "sessionId": "1_MX40NTU5Mjk0Mn5-MTQ2NzExNjQzNzM3Nn4wUTUzNnNURHlLQmdKWjNPUTVMdlNSSkd-fg",
                "hasAudio": true,
                "hasVideo": true,
                "name": "sabir",
                "outputMode": "individual",
            },
            processData: false,
            success: function (data) {
                console.log("success" + data);
                console.log(JSON.stringify(data));
            },
            error: function (errorThrown) {
                console.log("Error" + JSON.stringify(errorThrown));
            }
        });


        hide('startArchive');
        show('stopArchive');
    }

    // Stop archive
    function stopArchiveSession() {
        $.ajax({
            url: 'https://api.opentok.com/v2/partner/45592942/archive/arch_id/stop',
            dataType: 'json',
            type: 'post',
            contentType: 'application/json',
            headers: 'X-TB-PARTNER-AUTH: 45592942:92c49242824dd9e83890c8c282da3628e8d56752',
            processData: false,
            success: function (data) {
                console.log("success" + data);
                console.log(JSON.stringify(data));
            },
            error: function (errorThrown) {
                console.log("Error" + JSON.stringify(errorThrown));
            }
        });

        show('startArchive');
        hide('stopArchive');
    }

    // Test for VIDEO DISABLED:
    subscriber.on("videoDisabled", function (event) {
        // You may want to hide the subscriber video element:
        domElement = document.getElementById(subscriber.id);
        domElement.style["visibility"] = "hidden";
    });

TOGGLE AUDIO / VIDEO: subscriber.subscribeToAudio(false); // audio off

Events:

subscriber.on({
    audioLevelUpdated
    destroyed
    disconnected
    videoDimensionsChanged
    videoDisabled
    videoDisableWarning
    videoDisableWarningLifted
    videoEnabled Media Router resumes sending video.

exceptions:
    1004    Authentication error
    1005    Invalid Session ID
    1006    Connect Failed
    1007    Connect Rejected
    1008    Connect Time-out
    1009    Security Error
    1010    Not Connected
    1011    Invalid Parameter
    1013    Connection Failed
    1014    API Response Failure
    1026    Terms of Service Violation: Export Compliance
    1500    Unable to Publish
    1520    Unable to Force Disconnect
    1530    Unable to Force Unpublish
    1535    Force Unpublish on Invalid Stream
    2000    Internal Error
    2010    Report Issue Failure
</div>