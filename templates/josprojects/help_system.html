<style>

    ::-webkit-scrollbar {
        -webkit-appearance: none;
        width: 7px;
    }

    ::-webkit-scrollbar-thumb {
        border-radius: 4px;
        background-color: rgba(0, 0, 0, .5);
        -webkit-box-shadow: 0 0 1px rgba(255, 255, 255, .5);
    }

    #help_nav_tabs a, #help_nav_tabs a:visited {
        color: rgb(112, 154, 109);
        border: 3px dotted rgb(112, 154, 109);
        font-size: 18pt;
        font-weight: bold;
        height: 50px;
        margin: 0 15px;
        padding: 5px 15px;
        outline: none;
        width: 150px !important;
    }

    #help_nav_tabs a:hover, #help_nav_tabs a:focus {
        color: rgb(240, 173, 78);
        border-color: rgb(240, 173, 78);
    }

    .jos_tab_active {
        background-color: rgb(255, 255, 224) !important;
        border: 3px solid rgb(65, 45, 120) !important;
        border-bottom-color: rgb(255, 255, 224) !important;
        bottom: -3px !important;
        color: rgb(65, 45, 120) !important;
    }

    #help_nav_tabs li {
        text-align: center;
    }

    .tab-pane {
        left: 50px;
        overflow-x: hidden;
        overflow-y: scroll;
        margin-top: 20px;
        padding: 20px;
        position: fixed;
        top: 50px;
        height: 465px;
        width: 1100px;
        z-index: 165;
    }

    .tooltip .tooltip-inner {
        background: aliceblue;
        border: solid 2px rgb(65, 45, 120);
        color: rgb(65, 45, 120);
        font-family: 'Source Sans Pro', sans-serif;
        font-size: 16pt;
        padding: 5px;
    }

</style>

<!-- DEBUG -->
<div style="background-color: aliceblue; opacity: .7; padding: 15px; line-height: 1.5; color: blue; position: fixed; top: 50px; left: 450px; font-size: 14pt; width: 400px; z-index: 200; display: inherit;">
    DEBUG<br>
    <div class="row">
        <div class="col-xs-6">
            uc_note: <br>
            editor_status:<br>
{#            active tab: <br>#}
{#            help pos: <br>#}
{#            help item no: <br>#}
        </div>
        <div class="col-xs-6" style="color: red">
            {{ user_created_note }}<br>
            {{ request.session.editor_status }}<br>

{#            {{ request.session.active_tab }}<br>#}
{#            {{ request.session.help_position }}<br>#}
{#            {{ request.session.help_item_no }}<br>#}
        </div>
    </div>
</div>

<!-- help button -->
<button id="help_button" class="btn btn-info"
        style="position: fixed; top: -5px; left: 800px; font-size: 18pt; width: 150px; height: 45px; z-index: 200;"
        onclick="session_data_update('help_position');">
    My drawer
</button>

<!-- help screen -->
<div id="help_screen" class=" "
     style="
         background-color: white;
         display: none;
         height: 560px;
         left: 30px;
         padding: 0;
         position: fixed;
         top: 0;
         width: 1170px;
         z-index: 150;
     ">

    <div id="help_inner"
         style="
             background-color: rgb(255, 255, 224);
             height: 550px;
             left: 50px;
             outline: 3px solid rgb(65, 45, 120);
             position: fixed;
             top: 0;
             width: 1100px;
             z-index: 155;
         ">

        <ul id="help_nav_tabs"
            class="nav nav-tabs"
            style="background-color: white; position: fixed; top: 0; padding-top: 20px; left: 46px; width: 1107px; border-bottom: 3px solid rgb(65, 45, 120); z-index: 160;">

            <li><a id='to_do_btn' data-toggle="tab" href="#to_do">To do</a></li>

            <li><a id='how_do_i_btn' data-toggle="tab" href="#how_do_i">How do I?</a></li>

            <li><a id='my_notes_btn' data-toggle="tab" href="#my_notes">My notes</a></li>

        </ul>
    </div>
</div>

<div class="tab-content">

<div id="to_do" class="tab-pane fade">
    to_do
</div>

<div id="how_do_i" class="tab-pane fade josinstructions">
    <div id="main_help" style="padding: 15px 30px;">

         To search for a term:

        <input id="help_search_text" style="margin-left: 5px; padding: 5px; width: 350px;"
               type="text" placeholder="start typing here">
        <a class="btn btn-warning btn-sm"
           style="font-size: 14pt; margin-top: -7px; width: 70px;"
           href="javascript:location.reload();">
            Clear
        </a>

        <div id="help_search_results" class="row">

            {% if help_search_text %}
                <div class="josinstructions" style="color: #5bc0de; margin-top: 15px;">
                    Searching for "{{ help_search_text }}" - Found {{ help_items.count }} items:<br>
                </div>
            {% endif %}

            {% for help in help_items %}
                <ul>
                    <li style="margin-top: 30px;">
                        <a style="padding: 5px 12px;" href="javascript:showHelpItem('{{ help.id }}');">
                            {{ help.title }}
                        </a>
                    </li>
                </ul>
            {% endfor %}
        </div>
    </div>

    <button id='help_done_btn' class='btn btn-warning'
            style = 'width: 100px; position: fixed; top: 100px; left: 1025px; display: none;'
            onclick='showHelpItem();'>
        Back
    </button>

    <div id='help_item_content' class="row" style="margin-top: 15px; margin-left: 40px;"></div>
</div>

<div id="my_notes" class="tab-pane fade">

    <a id="notes_edit_btn"
       class="btn btn-info"
       style="width: 100px; position: fixed; top: 100px; left: 1025px;"
       onclick="activateCKEdit('user_created_notes_field')"
       data-toggle="tooltip"
       data-placement="bottom"
       title="Activates notes editor"
       >
        Edit
    </a>

    <a id="notes_cancel_btn"
       class="btn btn-danger"
       style="width: 100px; position: fixed; top: 160px; left: 1025px; display: none;"
       onclick="activateCKEdit('cancel')"
       data-toggle="tooltip"
       data-placement="bottom"
       title="Discards recent changes to notes"
    >
        Cancel
    </a>

    <div style="position: relative; top: 15px; width: 920px; left: 0;">
        <textarea id="user_created_notes_field" class="edit_border" readonly="readonly"
                  style="padding: 20px; width: 920px; height: 415px;">
            {{ user_created_note }}
        </textarea>
    </div>

</div>

</div>

<!-- help script -->
<script>

// user_created_notes_field editor

//////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////// Set up save /discard

function activateCKEdit() {

    edit_element = document.getElementById('user_created_notes_field');
    edit_btn = document.getElementById('notes_edit_btn');

    if ($(edit_btn).hasClass('btn-info')) {

        session_data_update('editor_status');
        $('#notes_cancel_btn').show();
        $(edit_btn).removeClass('btn-info').addClass('btn-success').text('Save');
        edit_element.removeAttribute('readonly');

        CKEDITOR.replace(edit_element, {
            toolbar: [
                {'name': 'clipboard', 'items': ['Undo', 'Redo', 'Cut', 'Copy', 'Paste']},
                {'name': 'editing', 'items': ['SelectAll', 'Find']}
            ],
            contentsCss: '/static/ckeditor/ckeditor/contents.css',
            disableNativeSpellChecker: false,
            width: 920,
            height: 370,
            //
            tabSpaces: 4,
            uiColor: '#28a4c9',
            extraPlugins: 'colorbutton',
            removePlugins: 'liststyle,tabletools,scayt,contextmenu'
        });

    } else {

        session_data_update('editor_status');
    }
}

// Deployment and Status Tracking
{
    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();

        /** The Ajax help search function. */
        var MILLS_TO_IGNORE_SEARCH = 100;
        /* This attaches a listener. Calling this again would attach a *second* */
        $('#help_search_text').keyup(_.debounce(processSearch, MILLS_TO_IGNORE_SEARCH, true));

        hb = document.getElementById('help_button');
        if ('{{ request.session.help_position }}' === 'down') {

            $(hb).text("Close").removeClass("btn-info").addClass("btn-warning");
            $("#fixed-top-bar").addClass('moveDown');
            $("#main_container").addClass('moveDown');
            $("#help_screen").slideDown("slow");

            active_tab = '#{{ request.session.active_tab }}';
            $(active_tab).tab('show');

            showHelpItem('{{ request.session.help_item_no }}');

            if ('{{ request.session.editor_status }}' === 'active') {
                activateCKEdit('user_created_notes_field');
            }

        } else {
            $(hb).text("My drawer").removeClass("btn-warning").addClass("btn-info");
            $("#fixed-top-bar").removeClass('moveDown');
            $("#main_container").removeClass('moveDown');
            $("#help_screen").slideUp("slow");
        }
    });

    function session_data_update(element) {
        var data = {};
        var textTest = false;

        if (element === 'help_position') {
            var hlpBtn = document.getElementById('help_button');
            var help_pos = 'up';
            if ($(hlpBtn).hasClass("btn-info")) {
                help_pos = 'down';
            }
            data = {"help_position": help_pos};

        } else if (element === 'active_tab') {
            var active_tab = $('.nav-tabs .jos_tab_active').attr('id');
            data = {"active_tab": active_tab};

        } else if (element === 'none') {
            data = {"help_item_no": 'none'};

        } else if (element === 'editor_status') {

            var status = 'inactive';
            if ($('#notes_edit_btn').hasClass('btn-info')) { status = 'active'; }
            data = {"editor_status": status};

        } else if (Number.isInteger(parseInt(element))) {
            data = {"help_item_no": element};

        } else {
            data = {}
        }

        console.log('session_data_update data: ' + JSON.stringify(data));

        if (data !== {}) {
            $.ajax({
                type: "POST",
                url: '/help_update/',
                data: data,
                success: function () {
                    if (element === 'help_position' && '{{ request.session.help_position }}' !== help_pos) {
                        location.reload();
                    }
                }
            });
        }
    }

    $('.nav-tabs').on({
        'show.bs.tab': function (event) {
            $('a').removeClass('jos_tab_active');
            $(event.target).addClass('jos_tab_active');
            session_data_update('active_tab');
        }
    });

    function showHelpItem(id) {
        id = typeof id !== 'undefined' ? id : 'none';

        if ($.isNumeric(id)) {

            $('#main_help').hide();
            $('#help_item_box').show();

            var config = {
                type: "GET",
                url: "{% url 'search_help' %}",
                data: {
                    'help_search_text': id
                },
                dataType: 'html',
                success: function (serverResponse_data) { //  textStatus_ignored, jqXHR_ignored
                    $('#help_item_content').html(serverResponse_data);
                    $('#help_done_btn').show();
                }
            };
            $.ajax(config);

        } else {
            $('#main_help').show();
            $('#help_item_box').hide();
            $('#help_done_btn').hide();
            id = 'none';
        }

        session_data_update(id);
    }
}

// HELP SEARCH
{
    /* Before our JavaScript, the urls need to be set. */
    var SUBMIT_URL = "{% url 'search_help' %}";

    /** Executes a search  */
    var processSearch = function () {
        //Get and trim the search text.
        var searchText = $('#help_search_text').val().trim().toLowerCase();

        if (searchText.length < 3) {
            //Too short. Ignore the submission, and erase any current results.
            $('#help_search_results').html("<i>Keep typing ...</i>");

        } else {
            console.log("SUBMIT_URL=" + SUBMIT_URL + "; help_search_text=" + searchText);
            // Execute the search.
            var processServerResponse = function (serverResponse_data) { //  textStatus_ignored, jqXHR_ignored

                $('#help_search_results').html(serverResponse_data);
            };

            var config = {
                type: "GET",
                url: SUBMIT_URL,
                data: {
                    'help_search_text': searchText
                },
                dataType: 'html',
                success: processServerResponse,
                fail: function () {
                    alert("Fail")
                }
            };
            $.ajax(config);
        }
    };
}

</script>